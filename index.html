<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>3D Print Cloud Calculator</title>
<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial,sans-serif;background:#0f172a;color:#e2e8f0;padding:16px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.gear{font-size:22px;cursor:pointer;display:none}
.container{display:flex;gap:16px;flex-wrap:wrap}
.card,.debug{background:#1e293b;padding:16px;border-radius:12px;width:100%;max-width:480px}
label{display:block;margin-top:10px;font-size:13px}
input,select{width:100%;padding:8px;border-radius:6px;border:none;background:#334155;color:white}
button{width:100%;padding:10px;margin-top:10px;border:none;border-radius:6px;background:#3b82f6;color:white;cursor:pointer}
button.secondary{background:#475569}
button.danger{background:#dc2626}
button:hover{opacity:.9}
.row{display:flex;gap:8px}
.row button{flex:1}
.debug-row{display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px dashed #334155}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);padding:16px;z-index:999;overflow:auto}
.modal-content{background:#1e293b;padding:16px;border-radius:12px;max-width:480px;margin:auto}
.list{margin-top:10px;border:1px solid #334155;border-radius:6px;overflow:hidden}
.list-item{padding:8px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #334155}
.list-item:last-child{border-bottom:none}
@media (min-width:768px){.gear{display:block}}
</style>
</head>
<body>

<div class="header">
    <h2>3D –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</h2>
    <div class="gear" onclick="openSettings()">‚öôÔ∏è</div>
</div>

<div class="container">

<!-- CALC -->
<div class="card">
    <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞</label>
    <input id="orderName">

    <label>–ü—Ä–∏–Ω—Ç–µ—Ä</label>
    <select id="printerSelect"></select>

    <label>–§–∏–ª–∞–º–µ–Ω—Ç</label>
    <select id="filamentSelect"></select>

    <label>–í–µ—Å (–≥)</label>
    <input type="number" id="weight">

    <label>–í—Ä–µ–º—è (—á)</label>
    <input type="number" id="time">

    <button onclick="calculate()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
    <div id="result"></div>
    <button id="acceptBtn" style="display:none" onclick="openOrder()">–ü—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑</button>
</div>

<!-- DEBUG -->
<div class="debug">
    <h3>–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è</h3>
    <div class="debug-row"><span>–ú–∞—Ç–µ—Ä–∏–∞–ª</span><span id="dMat">‚Äì</span></div>
    <div class="debug-row"><span>–≠–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—è</span><span id="dEl">‚Äì</span></div>
    <div class="debug-row"><span>–ê–º–æ—Ä—Ç–∏–∑–∞—Ü–∏—è</span><span id="dAm">‚Äì</span></div>
    <div class="debug-row"><span>–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å</span><span id="dCost">‚Äì</span></div>
    <div class="debug-row"><span>–ù–∞—Ü–µ–Ω–∫–∞</span><span id="dMarkup">‚Äì</span></div>
    <div class="debug-row"><strong>–¶–µ–Ω–∞</strong><strong id="dPrice">‚Äì</strong></div>
</div>

</div>

<!-- SETTINGS MODAL -->
<div class="modal" id="settingsModal">
<div class="modal-content">
    <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
    <label>–≠–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—è</label>
    <input id="sElectric">
    <label>–ù–∞—Ü–µ–Ω–∫–∞ (%)</label>
    <input id="sMarkup">
    <button onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>

    <h3>–ü—Ä–∏–Ω—Ç–µ—Ä—ã</h3>
    <button onclick="openPrinter()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–Ω—Ç–µ—Ä</button>
    <div class="list" id="printerList"></div>

    <h3>–§–∏–ª–∞–º–µ–Ω—Ç—ã</h3>
    <button onclick="openFilament()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª–∞–º–µ–Ω—Ç</button>
    <div class="list" id="filamentList"></div>

    <button class="secondary" onclick="closeAll()">–ó–∞–∫—Ä—ã—Ç—å</button>
</div>
</div>

<!-- PRINTER MODAL -->
<div class="modal" id="printerModal">
<div class="modal-content">
    <h3 id="printerTitle">–ü—Ä–∏–Ω—Ç–µ—Ä</h3>
    <input id="pName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
    <input id="pCost" placeholder="–°—Ç–æ–∏–º–æ—Å—Ç—å">
    <input id="pPower" placeholder="–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ (–∫–í—Ç)">
    <input id="pLife" placeholder="–†–µ—Å—É—Ä—Å (—á)">
    <button onclick="savePrinter()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button class="secondary" onclick="closeAll()">–û—Ç–º–µ–Ω–∞</button>
</div>
</div>

<!-- FILAMENT MODAL -->
<div class="modal" id="filamentModal">
<div class="modal-content">
    <h3 id="filamentTitle">–§–∏–ª–∞–º–µ–Ω—Ç</h3>
    <input id="fName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
    <input id="fType" placeholder="–ú–∞—Ç–µ—Ä–∏–∞–ª">
    <input id="fColor" placeholder="–¶–≤–µ—Ç">
    <input id="fPrice" placeholder="–¶–µ–Ω–∞ –∑–∞ –∫–≥">
    <button onclick="saveFilament()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button class="secondary" onclick="closeAll()">–û—Ç–º–µ–Ω–∞</button>
</div>
</div>

<!-- ORDER MODAL -->
<div class="modal" id="orderModal">
<div class="modal-content">
    <h3>–ü—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑</h3>
    <label>–ó–∞–∫–∞–∑—á–∏–∫</label>
    <input id="oCustomer">
    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
    <input id="oQty" value="1">
    <label>–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ</label>
    <input id="oParts" value="0">
    <label>–¶–µ–Ω–∞ –∑–∞ 1</label>
    <input id="oPrice">
    <label>–ò—Ç–æ–≥–æ</label>
    <input id="oTotal" disabled>
    <button onclick="saveOrder()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–∫–∞–∑</button>
    <button class="secondary" onclick="closeAll()">–û—Ç–º–µ–Ω–∞</button>
</div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbzZMT4AWpy3eOieFbSaA3gAiGZnA2uKW4y8FMx6erHBWqTcTiSZbt4IO6dmM8OTb4yYqA/exec";

let printers=[], filaments=[], settings={}, editIndex=null, lastPrice=0, lastCost=0;

async function loadAll(){
    try{
        const r = await fetch(API+"?action=getAll");
        const d = await r.json();
        printers=d.printers || [];
        filaments=d.filaments || [];
        settings=d.settings || {};

        printerSelect.innerHTML=printers.map(p=>`<option>${p.name}</option>`).join("");
        filamentSelect.innerHTML=filaments.map(f=>`<option>${f.name} | ${f.type} | ${f.color}</option>`).join("");

        renderLists();
    } catch(e){
        alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: "+e);
    }
}

function calculate(){
    if(!weight.value || !time.value) return alert("–í–≤–µ–¥–∏—Ç–µ –≤–µ—Å –∏ –≤—Ä–µ–º—è");
    const p=printers[printerSelect.selectedIndex];
    const f=filaments[filamentSelect.selectedIndex];

    const mat=(f.price/1000)*weight.value;
    const el=p.power*time.value*settings.electric;
    const am=(p.cost/p.life)*time.value;

    lastCost=mat+el+am;
    lastPrice=lastCost*(1+settings.markup/100);

    dMat.innerText=mat.toFixed(2);
    dEl.innerText=el.toFixed(2);
    dAm.innerText=am.toFixed(2);
    dCost.innerText=lastCost.toFixed(2);
    dMarkup.innerText=settings.markup+"%";
    dPrice.innerText=lastPrice.toFixed(2);

    result.innerText="–¶–µ–Ω–∞: "+lastPrice.toFixed(2);
    acceptBtn.style.display="block";
}

function openSettings(){
    sElectric.value=settings.electric || 0;
    sMarkup.value=settings.markup || 0;
    settingsModal.style.display="block";
}

async function saveSettings(){
    await fetch(API,{
        method:"POST",
        body: JSON.stringify({action:"saveSettings", item:{electric:sElectric.value, markup:sMarkup.value}})
    });
    closeAll(); loadAll();
}

/* Lists */
function renderLists(){
    printerList.innerHTML=printers.map((p,i)=>`
        <div class="list-item">
            ${p.name}
            <div>
                <button onclick="editPrinter(${i})">‚úèÔ∏è</button>
                <button class="danger" onclick="deletePrinter(${i})">üóë</button>
            </div>
        </div>`).join("");

    filamentList.innerHTML=filaments.map((f,i)=>`
        <div class="list-item">
            ${f.name} | ${f.type} | ${f.color}
            <div>
                <button onclick="editFilament(${i})">‚úèÔ∏è</button>
                <button class="danger" onclick="deleteFilament(${i})">üóë</button>
            </div>
        </div>`).join("");
}

/* Printer CRUD */
function openPrinter(){ editIndex=null; printerModal.style.display="block"; }
function editPrinter(i){
    editIndex=i;
    let p=printers[i];
    pName.value=p.name; pCost.value=p.cost; pPower.value=p.power; pLife.value=p.life;
    printerModal.style.display="block";
}
async function savePrinter(){
    const item={id:Date.now(),name:pName.value,cost:pCost.value,power:pPower.value,life:pLife.value};
    const action=editIndex===null?"addPrinter":"updatePrinter";
    await fetch(API,{method:"POST",body:JSON.stringify({action,index:editIndex,item})});
    closeAll(); loadAll();
}
async function deletePrinter(i){
    if(!confirm("–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å –ø—Ä–∏–Ω—Ç–µ—Ä?")) return;
    await fetch(API,{method:"POST",body:JSON.stringify({action:"deletePrinter",index:i})});
    loadAll();
}

/* Filament CRUD */
function openFilament(){ editIndex=null; filamentModal.style.display="block"; }
function editFilament(i){
    editIndex=i;
    let f=filaments[i];
    fName.value=f.name; fType.value=f.type; fColor.value=f.color; fPrice.value=f.price;
    filamentModal.style.display="block";
}
async function saveFilament(){
    const item={id:Date.now(),name:fName.value,type:fType.value,color:fColor.value,price:fPrice.value};
    const action=editIndex===null?"addFilament":"updateFilament";
    await fetch(API,{method:"POST",body:JSON.stringify({action,index:editIndex,item})});
    closeAll(); loadAll();
}
async function deleteFilament(i){
    if(!confirm("–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å —Ñ–∏–ª–∞–º–µ–Ω—Ç?")) return;
    await fetch(API,{method:"POST",body:JSON.stringify({action:"deleteFilament",index:i})});
    loadAll();
}

/* Order */
function openOrder(){
    oPrice.value=lastPrice.toFixed(2);
    oQty.value=1;
    oParts.value=0;
    updateTotal();
    orderModal.style.display="block";
}
function updateTotal(){ oTotal.value=(oPrice.value*oQty.value + Number(oParts.value)).toFixed(2) }
oQty.oninput=oPrice.oninput=oParts.oninput=updateTotal;

async function saveOrder(){
    await fetch(API,{method:"POST",body:JSON.stringify({
        action:"addOrder",
        item:{
            date:new Date().toLocaleString(),
            customer:oCustomer.value,
            printer:printerSelect.value,
            filament:filamentSelect.value,
            qty:oQty.value,
            parts:oParts.value,
            price:oPrice.value,
            total:oTotal.value,
            orderName:orderName.value
        }
    })});
    closeAll();
}

function closeAll(){
    document.querySelectorAll(".modal").forEach(m=>m.style.display="none");
}

loadAll();
</script>
</body>
</html>
