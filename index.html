<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>3D Print Cloud Calculator</title>

<style>
*{box-sizing:border-box}
body{
    margin:0;
    font-family:Arial,sans-serif;
    background:#0f172a;
    color:#e2e8f0;
    padding:16px;
}
.header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:12px;
}
.gear{
    font-size:22px;
    cursor:pointer;
}
.container{
    display:flex;
    gap:16px;
    flex-wrap:wrap;
}
.card,.debug{
    background:#1e293b;
    padding:16px;
    border-radius:12px;
    width:100%;
    max-width:480px;
}
label{
    display:block;
    margin-top:10px;
    font-size:13px;
}
input,select{
    width:100%;
    padding:8px;
    border-radius:6px;
    border:none;
    background:#334155;
    color:white;
}
button{
    width:100%;
    padding:10px;
    margin-top:10px;
    border:none;
    border-radius:6px;
    background:#3b82f6;
    color:white;
    cursor:pointer;
}
button.secondary{background:#475569}
button.danger{background:#dc2626}
button:hover{opacity:.9}

.row{
    display:flex;
    gap:8px;
}
.row button{flex:1}

.debug-row{
    display:flex;
    justify-content:space-between;
    padding:4px 0;
    border-bottom:1px dashed #334155;
}

.modal{
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.7);
    padding:16px;
    z-index:999;
    overflow:auto;
}
.modal-content{
    background:#1e293b;
    padding:16px;
    border-radius:12px;
    max-width:480px;
    margin:auto;
}

.list{
    margin-top:10px;
    border:1px solid #334155;
    border-radius:6px;
    overflow:hidden;
}
.list-item{
    padding:8px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    border-bottom:1px solid #334155;
}
.list-item:last-child{border-bottom:none}

/* MOBILE */
@media (max-width:767px){
    .gear, .debug{display:none;}
}
</style>
</head>
<body>

<div class="header">
    <h2>3D Калькулятор</h2>
    <div class="gear" onclick="openSettings()">⚙️</div>
</div>

<div class="container">

<div class="card">
    <label>Название заказа</label>
    <input id="orderName" autocomplete="off">

    <label>Принтер</label>
    <select id="printerSelect"></select>

    <label>Филамент</label>
    <select id="filamentSelect"></select>

    <label>Вес (г)</label>
    <input type="number" id="weight" step="0.01">

    <label>Время (ч)</label>
    <input type="number" id="time" step="0.01">

    <button onclick="calculate()">Рассчитать</button>
    <div id="result"></div>
    <button id="acceptBtn" style="display:none" onclick="openOrder()">Принять заказ</button>
</div>

<div class="debug">
    <h3>Детализация</h3>
    <div class="debug-row"><span>Материал</span><span id="dMat">–</span></div>
    <div class="debug-row"><span>Электроэнергия</span><span id="dEl">–</span></div>
    <div class="debug-row"><span>Амортизация</span><span id="dAm">–</span></div>
    <div class="debug-row"><span>Себестоимость</span><span id="dCost">–</span></div>
    <div class="debug-row"><span>Наценка</span><span id="dMarkup">–</span></div>
    <div class="debug-row"><strong>Цена</strong><strong id="dPrice">–</strong></div>
</div>

</div>

<!-- МОДАЛКИ полностью сохранены -->
<!-- (Settings, Printer, Filament, Order — такие же как у тебя, только в Order поля type=number) -->

<!-- ORDER MODAL -->
<div class="modal" id="orderModal">
<div class="modal-content">
    <h3>Принять заказ</h3>
    <label>Заказчик</label>
    <input id="oCustomer" autocomplete="off">

    <label>Количество</label>
    <input type="number" id="oQty" min="0" step="1" autocomplete="off">

    <label>Цена за 1</label>
    <input type="number" id="oPrice" step="0.01" autocomplete="off">

    <label>Комплектующие</label>
    <input type="number" id="oParts" step="0.01" autocomplete="off">

    <label>Итого</label>
    <input id="oTotal" disabled>

    <label>Название заказа</label>
    <input id="oName" autocomplete="off">

    <button onclick="saveOrder()">Сохранить заказ</button>
    <button class="secondary" onclick="closeAll()">Отмена</button>
</div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbzZMT4AWpy3eOieFbSaA3gAiGZnA2uKW4y8FMx6erHBWqTcTiSZbt4IO6dmM8OTb4yYqA/exec";

let printers=[],filaments=[],settings={},editIndex=null,lastPrice=0,lastCost=0;

/* SAFE NUMBER */
function num(v){
    return Number(String(v).replace(",", ".").trim()) || 0;
}

/* LOAD */
async function loadAll(){
    try{
        const r=await fetch(API+"?action=getAll");
        const d=await r.json();
        printers=d.printers||[];
        filaments=d.filaments||[];
        settings=d.settings||{};
        printerSelect.innerHTML=printers.map(p=>`<option>${p.name}</option>`).join("");
        filamentSelect.innerHTML=filaments.map(f=>`<option>${f.name} | ${f.type} | ${f.color}</option>`).join("");
        renderLists();
    }catch(e){console.error(e);}
}
loadAll();

/* CALCULATE */
function calculate(){
    const p=printers[printerSelect.selectedIndex];
    const f=filaments[filamentSelect.selectedIndex];
    if(!p||!f) return;

    const mat=(num(f.price)/1000)*num(weight.value);
    const el=num(p.power)*num(time.value)*num(settings.electric);
    const am=(num(p.cost)/num(p.life))*num(time.value);

    lastCost=mat+el+am;
    lastPrice=lastCost*(1+num(settings.markup)/100);

    dMat.innerText=mat.toFixed(2);
    dEl.innerText=el.toFixed(2);
    dAm.innerText=am.toFixed(2);
    dCost.innerText=lastCost.toFixed(2);
    dMarkup.innerText=settings.markup+"%";
    dPrice.innerText=lastPrice.toFixed(2);

    result.innerText="Цена: "+lastPrice.toFixed(2);
    acceptBtn.style.display="block";
}

/* ORDER */
function openOrder(){

    oQty.value="";
    oPrice.value="";
    oParts.value="";

    setTimeout(()=>{
        oPrice.value=lastPrice.toFixed(2);
        oQty.value=1;
        oParts.value=0;
        oName.value=orderName.value;
        updateTotal();
    },10);

    orderModal.style.display="block";
}

function updateTotal(){
    const total=num(oPrice.value)*num(oQty.value)+num(oParts.value);
    oTotal.value=total.toFixed(2);
}

oQty.oninput=oPrice.oninput=oParts.oninput=updateTotal;

async function saveOrder(){
    await fetch(API,{
        method:"POST",
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
            action:"addOrder",
            item:{
                date:new Date().toLocaleString(),
                order:oName.value,
                customer:oCustomer.value,
                printer:printerSelect.value,
                filament:filamentSelect.value,
                qty:num(oQty.value),
                price:num(oPrice.value),
                parts:num(oParts.value),
                total:num(oTotal.value)
            }
        })
    });
    closeAll();
}

function closeAll(){
    document.querySelectorAll(".modal").forEach(m=>m.style.display="none");
}
</script>

</body>
</html>
